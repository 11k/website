function chat(args){var protocol="https:"===location.protocol?"wss://":"ws://";this.server=protocol+args.options.host+"/ws",this.connected=!1,this.debug=!1,this.users={},this.ignorelist={},this.errorstrings={unknown:"Unknown error, this usually indicates an internal problem :(",nopermission:"You do not have the required permissions to use that",protocolerror:"Invalid or badly formatted",needlogin:"You have to be logged in to use that",invalidmsg:"The message was invalid",throttled:"Throttled! You were trying to send messages too fast",duplicate:"The message is identical to the last one you sent",muted:"You are muted (subscribing auto-removes mutes)",submode:"The channel is currently in subscriber only mode",needbanreason:"Providing a reason for the ban is mandatory",banned:"You have been banned (subscribing auto-removes non-permanent bans), disconnecting",requiresocket:"This chat requires WebSockets",toomanyconnections:"Only 5 concurrent connections allowed",socketerror:"Error contacting server",privmsgbanned:"Cannot send private messages while banned",privmsgaccounttooyoung:"Your account is too recent to send private messages",notfound:"The user was not found"},this.hints={hint:"Type in /hint for more hints",slashhelp:"Type in /help for more advanced features, like modifying the scrollback size",tabcompletion:"Use the tab key to auto-complete usernames and emotes (for user only completion prepend a @ or press shift)",hoveremotes:"Hovering your mouse over an emote will show you the emote code",highlight:"Chat messages containing your username will be highlighted",notify:"Use /msg <username> to send a private message to someone",ignoreuser:"Use /ignore <username> to hide messages from pesky chatters",emotewiki:"For the list of available emotes type /emotes or https://destiny.gg/emotes",mutespermanent:"Mutes are never persistent, don't worry it will pass!"},this.hintindex=[];for(var id in this.hints)this.hints.hasOwnProperty(id)&&this.hintindex.push(id);return this.user=new ChatUser(args.user),this.gui=new ChatGui(this,args.options),this.previousemote=null,this.originemote=null,this.showstarthint=!0,this}!function($){var ChatAutoComplete=function(input,emoticons){var self=this;if(!input||0==input.length||!input[0].setSelectionRange)return this;this.minWordLength=1,this.maxResults=10,this.buckets={},this.origVal=null,this.searchResults=[],this.searchIndex=-1,this.searchWord=null,this.input=$(input),this.expireUsers=$.proxy(this.expireUsers,this);for(var i=emoticons.length-1;i>=0;i--)this.addEmote(emoticons[i]);return setInterval(this.expireUsers,1e5),this.input.on({mousedown:function(){self.resetSearch()},keydown:function(e){if(9==e.keyCode){var forceUserSearch=e.shiftKey;return self.searchResults.length<=0&&(self.resetSearch(),self.searchSelectWord(forceUserSearch)),self.showAutoComplete(),!1}return self.resetSearch(),!0}}),this};ChatAutoComplete.prototype.getBucketId=function(str){return 0==str.length?"":str[0].toLowerCase()},ChatAutoComplete.prototype.addToBucket=function(data,weight,isemote,promoteTimestamp){if(this.input){var id=this.getBucketId(data);return this.buckets[id]||(this.buckets[id]={}),this.buckets[id][data]||(this.buckets[id][data]={data:data,weight:weight,isemote:!!isemote,promoted:promoteTimestamp}),this.buckets[id][data]}},ChatAutoComplete.prototype.addEmote=function(emote){return this.addToBucket(emote,1,!0,0),this},ChatAutoComplete.prototype.addNick=function(nick){return this.addToBucket(nick,1,!1,0),this},ChatAutoComplete.prototype.updateNick=function(nick){if(this.input){var weight=Date.now(),data=this.addToBucket(nick,weight,!1,0);return data.weight=weight,this}},ChatAutoComplete.prototype.promoteNick=function(nick){var promoteTimestamp=Date.now(),data=this.addToBucket(nick,1,!1,promoteTimestamp);return data.isemote?this:(data.promoted=promoteTimestamp,this)},ChatAutoComplete.prototype.getSearchWord=function(str,offset){var pre=str.substring(0,offset),post=str.substring(offset),startCaret=pre.lastIndexOf(" ")+1,endCaret=post.indexOf(" "),isUserSearch=!1;return startCaret>0&&(pre=pre.substring(startCaret)),endCaret>-1&&(post=post.substring(0,endCaret)),0===pre.lastIndexOf("@")&&(startCaret++,pre=pre.substring(1),isUserSearch=!0),{word:pre+post,startCaret:startCaret,isUserSearch:isUserSearch}},ChatAutoComplete.prototype.sortResults=function(a,b){return a&&b?a.promoted!=b.promoted?a.promoted>b.promoted?-1:1:a.isemote!=b.isemote?a.isemote&&!b.isemote?-1:1:a.weight!=b.weight?a.weight>b.weight?-1:1:(a=a.data.toLowerCase(),b=b.data.toLowerCase(),a==b?0:a>b?1:-1):0},ChatAutoComplete.prototype.searchBuckets=function(str,limit,usernamesOnly){str=str.trim().replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");var res=[],f=new RegExp("^"+str,"i"),data=this.buckets[this.getBucketId(str)]||{};for(var nick in data)!data.hasOwnProperty(nick)||usernamesOnly&&data[nick].isemote||f.test(nick)&&res.push(data[nick]);return res.sort(this.sortResults),res.slice(0,limit)},ChatAutoComplete.prototype.expireUsers=function(){var tenminutesago=Date.now()-6e5;for(var i in this.buckets)if(this.buckets.hasOwnProperty(i))for(var j in this.buckets[i])if(this.buckets[i].hasOwnProperty(j)){var data=this.buckets[i][j];!data.isemote&&data.promoted<=tenminutesago&&(data.promoted=0),!data.isemote&&data.weight<=tenminutesago&&(data.weight=1)}},ChatAutoComplete.prototype.markLastComplete=function(){if(this.lastComplete){var data=this.buckets[this.getBucketId(this.lastComplete)]||{};if(!data[this.lastComplete])return this.lastComplete=null;if(data[this.lastComplete].isemote){for(var j in data)data.hasOwnProperty(j)&&(data[j].promoted=0);return this.lastComplete=null}this.promoteNick(this.lastComplete),this.lastComplete=null}},ChatAutoComplete.prototype.resetSearch=function(){this.origVal=null,this.searchResults=[],this.searchIndex=-1,this.searchWord=null},ChatAutoComplete.prototype.searchSelectWord=function(forceUserSearch){var searchWord=this.getSearchWord(this.input.val(),this.input[0].selectionStart);if(searchWord.word.length>=this.minWordLength){this.searchWord=searchWord;var isUserSearch=forceUserSearch?!0:this.searchWord.isUserSearch;this.searchResults=this.searchBuckets(this.searchWord.word,this.maxResults,isUserSearch),this.origVal=this.input.val()}},ChatAutoComplete.prototype.showAutoComplete=function(){this.searchIndex>=this.searchResults.length-1?this.searchIndex=0:this.searchIndex=this.searchIndex+1;var result=this.searchResults[this.searchIndex];if(result&&result.data!=this.searchWord.word){this.lastComplete=result.data;var pre=this.origVal.substr(0,this.searchWord.startCaret),post=this.origVal.substr(this.searchWord.startCaret+this.searchWord.word.length);return(" "!=post[0]||0==post.length)&&(post=" "+post),this.input.focus().val(pre+result.data+post),this.input[0].setSelectionRange(pre.length+result.data.length+1,pre.length+result.data.length+1),!0}},window.ChatAutoComplete=ChatAutoComplete}(jQuery),function($){destiny.fn.GreenTextFormatter=function(chat){return this},destiny.fn.GreenTextFormatter.prototype.format=function(str,user){return user&&0===str.indexOf("&gt;")&&user.hasAnyFeatures(destiny.UserFeatures.SUBSCRIBERT3,destiny.UserFeatures.SUBSCRIBERT4,destiny.UserFeatures.SUBSCRIBERT2,destiny.UserFeatures.ADMIN,destiny.UserFeatures.MODERATOR)&&(str='<span class="greentext">'+str+"</span>"),str},destiny.fn.EmoteFormatter=function(chat){return this.emoteregex=new RegExp("(^|\\s)("+chat.emoticons.join("|")+")(?=$|\\s)"),this.gemoteregex=new RegExp("(^|\\s)("+chat.emoticons.join("|")+")(?=$|\\s)","gm"),this.twitchemoteregex=new RegExp("(^|\\s)("+chat.emoticons.join("|")+"|"+chat.twitchemotes.join("|")+")(?=$|\\s)","gm"),this},destiny.fn.EmoteFormatter.prototype.format=function(str,user){var emoteregex=this.emoteregex;return user&&user.features.length>0&&(emoteregex=user.hasFeature(destiny.UserFeatures.SUBSCRIBERT0)?this.twitchemoteregex:this.gemoteregex),str.replace(emoteregex,'$1<div title="$2" class="chat-emote chat-emote-$2">$2 </div>')},destiny.fn.MentionedUserFormatter=function(chat){return this.users=chat.engine.users,this.userregex=/((?:^|\s)@?)([a-zA-Z0-9_]{3,20})(?=$|\s|[\.\?!,])/g,this},destiny.fn.MentionedUserFormatter.prototype.format=function(str,user){var users=this.users;return str.replace(this.userregex,function(match,prefix,nick){return users.propertyIsEnumerable(nick)?prefix+'<span class="chat-user">'+nick+"</span>":match})}}(jQuery),function($){destiny.fn.UrlFormatter=function(chat){var unicodeShortcuts={"p{L}":"\\u0041-\\u005A\\u0061-\\u007A\\u00AA\\u00B5\\u00BA\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02C1\\u02C6-\\u02D1\\u02E0-\\u02E4\\u02EC\\u02EE\\u0370-\\u0374\\u0376\\u0377\\u037A-\\u037D\\u0386\\u0388-\\u038A\\u038C\\u038E-\\u03A1\\u03A3-\\u03F5\\u03F7-\\u0481\\u048A-\\u0527\\u0531-\\u0556\\u0559\\u0561-\\u0587\\u05D0-\\u05EA\\u05F0-\\u05F2\\u0620-\\u064A\\u066E\\u066F\\u0671-\\u06D3\\u06D5\\u06E5\\u06E6\\u06EE\\u06EF\\u06FA-\\u06FC\\u06FF\\u0710\\u0712-\\u072F\\u074D-\\u07A5\\u07B1\\u07CA-\\u07EA\\u07F4\\u07F5\\u07FA\\u0800-\\u0815\\u081A\\u0824\\u0828\\u0840-\\u0858\\u08A0\\u08A2-\\u08AC\\u0904-\\u0939\\u093D\\u0950\\u0958-\\u0961\\u0971-\\u0977\\u0979-\\u097F\\u0985-\\u098C\\u098F\\u0990\\u0993-\\u09A8\\u09AA-\\u09B0\\u09B2\\u09B6-\\u09B9\\u09BD\\u09CE\\u09DC\\u09DD\\u09DF-\\u09E1\\u09F0\\u09F1\\u0A05-\\u0A0A\\u0A0F\\u0A10\\u0A13-\\u0A28\\u0A2A-\\u0A30\\u0A32\\u0A33\\u0A35\\u0A36\\u0A38\\u0A39\\u0A59-\\u0A5C\\u0A5E\\u0A72-\\u0A74\\u0A85-\\u0A8D\\u0A8F-\\u0A91\\u0A93-\\u0AA8\\u0AAA-\\u0AB0\\u0AB2\\u0AB3\\u0AB5-\\u0AB9\\u0ABD\\u0AD0\\u0AE0\\u0AE1\\u0B05-\\u0B0C\\u0B0F\\u0B10\\u0B13-\\u0B28\\u0B2A-\\u0B30\\u0B32\\u0B33\\u0B35-\\u0B39\\u0B3D\\u0B5C\\u0B5D\\u0B5F-\\u0B61\\u0B71\\u0B83\\u0B85-\\u0B8A\\u0B8E-\\u0B90\\u0B92-\\u0B95\\u0B99\\u0B9A\\u0B9C\\u0B9E\\u0B9F\\u0BA3\\u0BA4\\u0BA8-\\u0BAA\\u0BAE-\\u0BB9\\u0BD0\\u0C05-\\u0C0C\\u0C0E-\\u0C10\\u0C12-\\u0C28\\u0C2A-\\u0C33\\u0C35-\\u0C39\\u0C3D\\u0C58\\u0C59\\u0C60\\u0C61\\u0C85-\\u0C8C\\u0C8E-\\u0C90\\u0C92-\\u0CA8\\u0CAA-\\u0CB3\\u0CB5-\\u0CB9\\u0CBD\\u0CDE\\u0CE0\\u0CE1\\u0CF1\\u0CF2\\u0D05-\\u0D0C\\u0D0E-\\u0D10\\u0D12-\\u0D3A\\u0D3D\\u0D4E\\u0D60\\u0D61\\u0D7A-\\u0D7F\\u0D85-\\u0D96\\u0D9A-\\u0DB1\\u0DB3-\\u0DBB\\u0DBD\\u0DC0-\\u0DC6\\u0E01-\\u0E30\\u0E32\\u0E33\\u0E40-\\u0E46\\u0E81\\u0E82\\u0E84\\u0E87\\u0E88\\u0E8A\\u0E8D\\u0E94-\\u0E97\\u0E99-\\u0E9F\\u0EA1-\\u0EA3\\u0EA5\\u0EA7\\u0EAA\\u0EAB\\u0EAD-\\u0EB0\\u0EB2\\u0EB3\\u0EBD\\u0EC0-\\u0EC4\\u0EC6\\u0EDC-\\u0EDF\\u0F00\\u0F40-\\u0F47\\u0F49-\\u0F6C\\u0F88-\\u0F8C\\u1000-\\u102A\\u103F\\u1050-\\u1055\\u105A-\\u105D\\u1061\\u1065\\u1066\\u106E-\\u1070\\u1075-\\u1081\\u108E\\u10A0-\\u10C5\\u10C7\\u10CD\\u10D0-\\u10FA\\u10FC-\\u1248\\u124A-\\u124D\\u1250-\\u1256\\u1258\\u125A-\\u125D\\u1260-\\u1288\\u128A-\\u128D\\u1290-\\u12B0\\u12B2-\\u12B5\\u12B8-\\u12BE\\u12C0\\u12C2-\\u12C5\\u12C8-\\u12D6\\u12D8-\\u1310\\u1312-\\u1315\\u1318-\\u135A\\u1380-\\u138F\\u13A0-\\u13F4\\u1401-\\u166C\\u166F-\\u167F\\u1681-\\u169A\\u16A0-\\u16EA\\u1700-\\u170C\\u170E-\\u1711\\u1720-\\u1731\\u1740-\\u1751\\u1760-\\u176C\\u176E-\\u1770\\u1780-\\u17B3\\u17D7\\u17DC\\u1820-\\u1877\\u1880-\\u18A8\\u18AA\\u18B0-\\u18F5\\u1900-\\u191C\\u1950-\\u196D\\u1970-\\u1974\\u1980-\\u19AB\\u19C1-\\u19C7\\u1A00-\\u1A16\\u1A20-\\u1A54\\u1AA7\\u1B05-\\u1B33\\u1B45-\\u1B4B\\u1B83-\\u1BA0\\u1BAE\\u1BAF\\u1BBA-\\u1BE5\\u1C00-\\u1C23\\u1C4D-\\u1C4F\\u1C5A-\\u1C7D\\u1CE9-\\u1CEC\\u1CEE-\\u1CF1\\u1CF5\\u1CF6\\u1D00-\\u1DBF\\u1E00-\\u1F15\\u1F18-\\u1F1D\\u1F20-\\u1F45\\u1F48-\\u1F4D\\u1F50-\\u1F57\\u1F59\\u1F5B\\u1F5D\\u1F5F-\\u1F7D\\u1F80-\\u1FB4\\u1FB6-\\u1FBC\\u1FBE\\u1FC2-\\u1FC4\\u1FC6-\\u1FCC\\u1FD0-\\u1FD3\\u1FD6-\\u1FDB\\u1FE0-\\u1FEC\\u1FF2-\\u1FF4\\u1FF6-\\u1FFC\\u2071\\u207F\\u2090-\\u209C\\u2102\\u2107\\u210A-\\u2113\\u2115\\u2119-\\u211D\\u2124\\u2126\\u2128\\u212A-\\u212D\\u212F-\\u2139\\u213C-\\u213F\\u2145-\\u2149\\u214E\\u2183\\u2184\\u2C00-\\u2C2E\\u2C30-\\u2C5E\\u2C60-\\u2CE4\\u2CEB-\\u2CEE\\u2CF2\\u2CF3\\u2D00-\\u2D25\\u2D27\\u2D2D\\u2D30-\\u2D67\\u2D6F\\u2D80-\\u2D96\\u2DA0-\\u2DA6\\u2DA8-\\u2DAE\\u2DB0-\\u2DB6\\u2DB8-\\u2DBE\\u2DC0-\\u2DC6\\u2DC8-\\u2DCE\\u2DD0-\\u2DD6\\u2DD8-\\u2DDE\\u2E2F\\u3005\\u3006\\u3031-\\u3035\\u303B\\u303C\\u3041-\\u3096\\u309D-\\u309F\\u30A1-\\u30FA\\u30FC-\\u30FF\\u3105-\\u312D\\u3131-\\u318E\\u31A0-\\u31BA\\u31F0-\\u31FF\\u3400-\\u4DB5\\u4E00-\\u9FCC\\uA000-\\uA48C\\uA4D0-\\uA4FD\\uA500-\\uA60C\\uA610-\\uA61F\\uA62A\\uA62B\\uA640-\\uA66E\\uA67F-\\uA697\\uA6A0-\\uA6E5\\uA717-\\uA71F\\uA722-\\uA788\\uA78B-\\uA78E\\uA790-\\uA793\\uA7A0-\\uA7AA\\uA7F8-\\uA801\\uA803-\\uA805\\uA807-\\uA80A\\uA80C-\\uA822\\uA840-\\uA873\\uA882-\\uA8B3\\uA8F2-\\uA8F7\\uA8FB\\uA90A-\\uA925\\uA930-\\uA946\\uA960-\\uA97C\\uA984-\\uA9B2\\uA9CF\\uAA00-\\uAA28\\uAA40-\\uAA42\\uAA44-\\uAA4B\\uAA60-\\uAA76\\uAA7A\\uAA80-\\uAAAF\\uAAB1\\uAAB5\\uAAB6\\uAAB9-\\uAABD\\uAAC0\\uAAC2\\uAADB-\\uAADD\\uAAE0-\\uAAEA\\uAAF2-\\uAAF4\\uAB01-\\uAB06\\uAB09-\\uAB0E\\uAB11-\\uAB16\\uAB20-\\uAB26\\uAB28-\\uAB2E\\uABC0-\\uABE2\\uAC00-\\uD7A3\\uD7B0-\\uD7C6\\uD7CB-\\uD7FB\\uF900-\\uFA6D\\uFA70-\\uFAD9\\uFB00-\\uFB06\\uFB13-\\uFB17\\uFB1D\\uFB1F-\\uFB28\\uFB2A-\\uFB36\\uFB38-\\uFB3C\\uFB3E\\uFB40\\uFB41\\uFB43\\uFB44\\uFB46-\\uFBB1\\uFBD3-\\uFD3D\\uFD50-\\uFD8F\\uFD92-\\uFDC7\\uFDF0-\\uFDFB\\uFE70-\\uFE74\\uFE76-\\uFEFC\\uFF21-\\uFF3A\\uFF41-\\uFF5A\\uFF66-\\uFFBE\\uFFC2-\\uFFC7\\uFFCA-\\uFFCF\\uFFD2-\\uFFD7\\uFFDA-\\uFFDC","p{N}":"\\u0030-\\u0039\\u00B2\\u00B3\\u00B9\\u00BC-\\u00BE\\u0660-\\u0669\\u06F0-\\u06F9\\u07C0-\\u07C9\\u0966-\\u096F\\u09E6-\\u09EF\\u09F4-\\u09F9\\u0A66-\\u0A6F\\u0AE6-\\u0AEF\\u0B66-\\u0B6F\\u0B72-\\u0B77\\u0BE6-\\u0BF2\\u0C66-\\u0C6F\\u0C78-\\u0C7E\\u0CE6-\\u0CEF\\u0D66-\\u0D75\\u0E50-\\u0E59\\u0ED0-\\u0ED9\\u0F20-\\u0F33\\u1040-\\u1049\\u1090-\\u1099\\u1369-\\u137C\\u16EE-\\u16F0\\u17E0-\\u17E9\\u17F0-\\u17F9\\u1810-\\u1819\\u1946-\\u194F\\u19D0-\\u19DA\\u1A80-\\u1A89\\u1A90-\\u1A99\\u1B50-\\u1B59\\u1BB0-\\u1BB9\\u1C40-\\u1C49\\u1C50-\\u1C59\\u2070\\u2074-\\u2079\\u2080-\\u2089\\u2150-\\u2182\\u2185-\\u2189\\u2460-\\u249B\\u24EA-\\u24FF\\u2776-\\u2793\\u2CFD\\u3007\\u3021-\\u3029\\u3038-\\u303A\\u3192-\\u3195\\u3220-\\u3229\\u3248-\\u324F\\u3251-\\u325F\\u3280-\\u3289\\u32B1-\\u32BF\\uA620-\\uA629\\uA6E6-\\uA6EF\\uA830-\\uA835\\uA8D0-\\uA8D9\\uA900-\\uA909\\uA9D0-\\uA9D9\\uAA50-\\uAA59\\uABF0-\\uABF9\\uFF10-\\uFF19","p{Sc}":"\\u0024\\u00A2-\\u00A5\\u058F\\u060B\\u09F2\\u09F3\\u09FB\\u0AF1\\u0BF9\\u0E3F\\u17DB\\u20A0-\\u20B9\\uA838\\uFDFC\\uFE69\\uFF04\\uFFE0\\uFFE1\\uFFE5\\uFFE6","p{Sk}":"\\u005E\\u0060\\u00A8\\u00AF\\u00B4\\u00B8\\u02C2-\\u02C5\\u02D2-\\u02DF\\u02E5-\\u02EB\\u02ED\\u02EF-\\u02FF\\u0375\\u0384\\u0385\\u1FBD\\u1FBF-\\u1FC1\\u1FCD-\\u1FCF\\u1FDD-\\u1FDF\\u1FED-\\u1FEF\\u1FFD\\u1FFE\\u309B\\u309C\\uA700-\\uA716\\uA720\\uA721\\uA789\\uA78A\\uFBB2-\\uFBC1\\uFF3E\\uFF40\\uFFE3","p{So}":"\\u00A6\\u00A9\\u00AE\\u00B0\\u0482\\u060E\\u060F\\u06DE\\u06E9\\u06FD\\u06FE\\u07F6\\u09FA\\u0B70\\u0BF3-\\u0BF8\\u0BFA\\u0C7F\\u0D79\\u0F01-\\u0F03\\u0F13\\u0F15-\\u0F17\\u0F1A-\\u0F1F\\u0F34\\u0F36\\u0F38\\u0FBE-\\u0FC5\\u0FC7-\\u0FCC\\u0FCE\\u0FCF\\u0FD5-\\u0FD8\\u109E\\u109F\\u1390-\\u1399\\u1940\\u19DE-\\u19FF\\u1B61-\\u1B6A\\u1B74-\\u1B7C\\u2100\\u2101\\u2103-\\u2106\\u2108\\u2109\\u2114\\u2116\\u2117\\u211E-\\u2123\\u2125\\u2127\\u2129\\u212E\\u213A\\u213B\\u214A\\u214C\\u214D\\u214F\\u2195-\\u2199\\u219C-\\u219F\\u21A1\\u21A2\\u21A4\\u21A5\\u21A7-\\u21AD\\u21AF-\\u21CD\\u21D0\\u21D1\\u21D3\\u21D5-\\u21F3\\u2300-\\u2307\\u230C-\\u231F\\u2322-\\u2328\\u232B-\\u237B\\u237D-\\u239A\\u23B4-\\u23DB\\u23E2-\\u23F3\\u2400-\\u2426\\u2440-\\u244A\\u249C-\\u24E9\\u2500-\\u25B6\\u25B8-\\u25C0\\u25C2-\\u25F7\\u2600-\\u266E\\u2670-\\u26FF\\u2701-\\u2767\\u2794-\\u27BF\\u2800-\\u28FF\\u2B00-\\u2B2F\\u2B45\\u2B46\\u2B50-\\u2B59\\u2CE5-\\u2CEA\\u2E80-\\u2E99\\u2E9B-\\u2EF3\\u2F00-\\u2FD5\\u2FF0-\\u2FFB\\u3004\\u3012\\u3013\\u3020\\u3036\\u3037\\u303E\\u303F\\u3190\\u3191\\u3196-\\u319F\\u31C0-\\u31E3\\u3200-\\u321E\\u322A-\\u3247\\u3250\\u3260-\\u327F\\u328A-\\u32B0\\u32C0-\\u32FE\\u3300-\\u33FF\\u4DC0-\\u4DFF\\uA490-\\uA4C6\\uA828-\\uA82B\\uA836\\uA837\\uA839\\uAA77-\\uAA79\\uFDFD\\uFFE4\\uFFE8\\uFFED\\uFFEE\\uFFFC\\uFFFD"},letter=unicodeShortcuts["p{L}"],number=unicodeShortcuts["p{N}"],iriChar=letter+number,pathChar=iriChar+"/\\-+=_&~*%@|#.,:;'?!"+unicodeShortcuts["p{Sc}"]+unicodeShortcuts["p{Sk}"]+unicodeShortcuts["p{So}"],endChar=iriChar+"/\\-+=_&~*%;"+unicodeShortcuts["p{Sc}"],octet="(?:25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])",ipAddr="(?:\\b"+octet+"\\."+octet+"\\."+octet+"\\."+octet+"\\b)",iri="["+iriChar+"](?:["+iriChar+"\\-]*["+iriChar+"])?",domain="(?:"+iri+"\\.)+",gtld="(?:NORTHWESTERNMUTUAL|TRAVELERSINSURANCE|AMERICANEXPRESS|KERRYPROPERTIES|SANDVIKCOROMANT|AFAMILYCOMPANY|AMERICANFAMILY|BANANAREPUBLIC|CANCERRESEARCH|COOKINGCHANNEL|KERRYLOGISTICS|WEATHERCHANNEL|INTERNATIONAL|LIFEINSURANCE|ORIENTEXPRESS|SPREADBETTING|TRAVELCHANNEL|WOLTERSKLUWER|CONSTRUCTION|LPLFINANCIAL|PAMPEREDCHEF|SCHOLARSHIPS|VERSICHERUNG|ACCOUNTANTS|BARCLAYCARD|BLACKFRIDAY|BLOCKBUSTER|BRIDGESTONE|CALVINKLEIN|CONTRACTORS|CREDITUNION|ENGINEERING|ENTERPRISES|FOODNETWORK|INVESTMENTS|KERRYHOTELS|LAMBORGHINI|MOTORCYCLES|OLAYANGROUP|PHOTOGRAPHY|PLAYSTATION|PRODUCTIONS|PROGRESSIVE|REDUMBRELLA|RIGHTATHOME|WILLIAMHILL|ACCOUNTANT|APARTMENTS|ASSOCIATES|BASKETBALL|BNPPARIBAS|BOEHRINGER|CAPITALONE|CONSULTING|CREDITCARD|CUISINELLA|EUROVISION|EXTRASPACE|FOUNDATION|HEALTHCARE|IMMOBILIEN|INDUSTRIES|MANAGEMENT|MITSUBISHI|NATIONWIDE|NEWHOLLAND|NEXTDIRECT|ONYOURSIDE|PROPERTIES|PROTECTION|PRUDENTIAL|REALESTATE|REPUBLICAN|RESTAURANT|SCHAEFFLER|SWIFTCOVER|TATAMOTORS|TECHNOLOGY|TELEFONICA|UNIVERSITY|VISTAPRINT|VLAANDEREN|VOLKSWAGEN|ACCENTURE|ALFAROMEO|ALLFINANZ|AMSTERDAM|ANALYTICS|AQUARELLE|BARCELONA|BLOOMBERG|CHRISTMAS|COMMUNITY|DIRECTORY|EDUCATION|EQUIPMENT|FAIRWINDS|FINANCIAL|FIRESTONE|FRESENIUS|FRONTDOOR|FUJIXEROX|FURNITURE|GOLDPOINT|GOODHANDS|HISAMITSU|HOMEDEPOT|HOMEGOODS|HOMESENSE|HONEYWELL|INSTITUTE|INSURANCE|KUOKGROUP|LADBROKES|LANCASTER|LANDROVER|LIFESTYLE|MARKETING|MARSHALLS|MCDONALDS|MELBOURNE|MICROSOFT|MONTBLANC|PANASONIC|PASSAGENS|PRAMERICA|RICHARDLI|SCJOHNSON|SHANGRILA|SOLUTIONS|STATEBANK|STATEFARM|STOCKHOLM|TRAVELERS|VACATIONS|YODOBASHI|ABUDHABI|AIRFORCE|ALLSTATE|ATTORNEY|BARCLAYS|BAREFOOT|BARGAINS|BASEBALL|BOUTIQUE|BRADESCO|BROADWAY|BRUSSELS|BUDAPEST|BUILDERS|BUSINESS|CAPETOWN|CATERING|CHRYSLER|CIPRIANI|CITYEATS|CLEANING|CLINIQUE|CLOTHING|COMMBANK|COMPUTER|DELIVERY|DELOITTE|DEMOCRAT|DIAMONDS|DISCOUNT|DISCOVER|DOWNLOAD|ENGINEER|ERICSSON|ESURANCE|EVERBANK|EXCHANGE|FEEDBACK|FIDELITY|FIRMDALE|FOOTBALL|FRONTIER|GOODYEAR|GRAINGER|GRAPHICS|GUARDIAN|HDFCBANK|HELSINKI|HOLDINGS|INFINITI|IPIRANGA|ISTANBUL|JPMORGAN|LIGHTING|LUNDBECK|MARRIOTT|MASERATI|MCKINSEY|MEMORIAL|MORTGAGE|MOVISTAR|MUTUELLE|OBSERVER|PARTNERS|PHARMACY|PICTURES|PLUMBING|PROPERTY|REDSTONE|SAARLAND|SAMSCLUB|SECURITY|SERVICES|SHOPPING|SHOWTIME|SOFTBANK|SOFTWARE|STCGROUP|SUPPLIES|SYMANTEC|TELECITY|TRAINING|UCONNECT|VANGUARD|VENTURES|VERISIGN|WOODSIDE|YOKOHAMA|ABOGADO|ACADEMY|AGAKHAN|ALIBABA|ANDROID|ATHLETA|AUCTION|AUDIBLE|AUSPOST|AVIANCA|BANAMEX|BAUHAUS|BENTLEY|BESTBUY|BOOKING|BROTHER|BUGATTI|CAPITAL|CARAVAN|CAREERS|CARTIER|CHANNEL|CHINTAI|CITADEL|CLUBMED|COLLEGE|COLOGNE|COMCAST|COMPANY|COMPARE|CONTACT|COOKING|CORSICA|COUNTRY|COUPONS|COURSES|CRICKET|CRUISES|DENTIST|DIGITAL|DOMAINS|EXPOSED|EXPRESS|FARMERS|FASHION|FERRARI|FERRERO|FINANCE|FISHING|FITNESS|FLIGHTS|FLORIST|FLOWERS|FORSALE|FROGANS|FUJITSU|GALLERY|GENTING|GODADDY|GUITARS|HAMBURG|HANGOUT|HITACHI|HOLIDAY|HOSTING|HOTELES|HOTMAIL|HYUNDAI|ISELECT|ISMAILI|JEWELRY|JUNIPER|KITCHEN|KOMATSU|LACAIXA|LANCOME|LANXESS|LASALLE|LATROBE|LECLERC|LIAISON|LIMITED|LINCOLN|MARKETS|METLIFE|MONSTER|NETBANK|NETFLIX|NETWORK|NEUSTAR|OKINAWA|OLDNAVY|ORGANIC|ORIGINS|PANERAI|PHILIPS|PIONEER|POLITIE|REALTOR|RECIPES|RENTALS|REVIEWS|REXROTH|SAMSUNG|SANDVIK|SCHMIDT|SCHWARZ|SCIENCE|SHIKSHA|SHRIRAM|SINGLES|SPIEGEL|STAPLES|STARHUB|STATOIL|STORAGE|SUPPORT|SURGERY|SYSTEMS|TEMASEK|THEATER|THEATRE|TICKETS|TIFFANY|TOSHIBA|TRADING|WALMART|WANGGOU|WATCHES|WEATHER|WEBSITE|WEDDING|WHOSWHO|WINDOWS|WINNERS|XFINITY|YAMAXUN|YOUTUBE|ZUERICH|ABARTH|ABBOTT|ABBVIE|ACTIVE|AGENCY|AIRBUS|AIRTEL|ALIPAY|ALSACE|ALSTOM|ANQUAN|ARAMCO|AUTHOR|BAYERN|BEAUTY|BERLIN|BHARTI|BLANCO|BOSTIK|BROKER|CAMERA|CAREER|CASEIH|CASINO|CENTER|CHANEL|CHROME|CHURCH|CIRCLE|CLAIMS|CLINIC|COFFEE|COMSEC|CONDOS|COUPON|CREDIT|CRUISE|DATING|DATSUN|DEALER|DEGREE|DENTAL|DESIGN|DIRECT|DOCTOR|DUNLOP|DUPONT|DURBAN|EMERCK|ENERGY|ESTATE|EVENTS|EXPERT|FAMILY|FLICKR|FUTBOL|GALLUP|GARDEN|GEORGE|GIVING|GLOBAL|GOOGLE|GRATIS|HEALTH|HERMES|HIPHOP|HOCKEY|HUGHES|IMAMAT|INSURE|INTUIT|JAGUAR|JOBURG|JUEGOS|KAUFEN|KINDER|KINDLE|KOSHER|LANCIA|LATINO|LAWYER|LEFRAK|LIVING|LOCKER|LONDON|LUXURY|MADRID|MAISON|MAKEUP|MARKET|MATTEL|MOBILY|MONASH|MORMON|MOSCOW|MUSEUM|MUTUAL|NAGOYA|NATURA|NISSAN|NISSAY|NORTON|NOWRUZ|OFFICE|OLAYAN|ONLINE|ORACLE|ORANGE|OTSUKA|PFIZER|PHOTOS|PHYSIO|PIAGET|PICTET|QUEBEC|RACING|REALTY|REISEN|REPAIR|REPORT|REVIEW|ROCHER|ROGERS|RYUKYU|SAFETY|SAKURA|SANOFI|SCHOOL|SCHULE|SECURE|SELECT|SHOUJI|SOCCER|SOCIAL|STREAM|STUDIO|SUPPLY|SUZUKI|SWATCH|SYDNEY|TAIPEI|TAOBAO|TARGET|TATTOO|TENNIS|TIENDA|TJMAXX|TKMAXX|TOYOTA|TRAVEL|UNICOM|VIAJES|VIKING|VILLAS|VIRGIN|VISION|VOTING|VOYAGE|VUELOS|WALTER|WARMAN|WEBCAM|XIHUAN|XPERIA|YACHTS|YANDEX|ZAPPOS|ACTOR|ADULT|AETNA|AMFAM|AMICA|APPLE|ARCHI|AUDIO|AUTOS|AZURE|BAIDU|BEATS|BIBLE|BINGO|BLACK|BOATS|BOOTS|BOSCH|BUILD|CANON|CARDS|CHASE|CHEAP|CHLOE|CISCO|CITIC|CLICK|CLOUD|COACH|CODES|CROWN|CYMRU|DABUR|DANCE|DEALS|DELTA|DODGE|DRIVE|DUBAI|EARTH|EDEKA|EMAIL|EPOST|EPSON|FAITH|FEDEX|FINAL|FOREX|FORUM|GALLO|GAMES|GIFTS|GIVES|GLADE|GLASS|GLOBO|GMAIL|GREEN|GRIPE|GROUP|GUCCI|GUIDE|HOMES|HONDA|HORSE|HOUSE|HYATT|IINET|IKANO|INTEL|IRISH|IVECO|JETZT|KOELN|KYOTO|LAMER|LEASE|LEGAL|LEXUS|LILLY|LINDE|LIPSY|LIXIL|LOANS|LOCUS|LOTTE|LOTTO|LUPIN|MACYS|MANGO|MEDIA|MIAMI|MONEY|MOPAR|MOVIE|NADEX|NEXUS|NIKON|NINJA|NOKIA|NOWTV|OMEGA|OSAKA|PARIS|PARTS|PARTY|PHOTO|PIZZA|PLACE|POKER|PRAXI|PRESS|PRIME|PROMO|QUEST|RADIO|REHAB|REISE|RICOH|ROCKS|RODEO|SALON|SENER|SEVEN|SHARP|SHELL|SHOES|SKYPE|SLING|SMART|SMILE|SOLAR|SPACE|STADA|STORE|STUDY|STYLE|SUCKS|SWISS|TATAR|TIRES|TIROL|TMALL|TODAY|TOKYO|TOOLS|TORAY|TOTAL|TOURS|TRADE|TRUST|TUNES|TUSHU|UBANK|VEGAS|VIDEO|VISTA|VODKA|VOLVO|WALES|WATCH|WEBER|WEIBO|WORKS|WORLD|XEROX|YAHOO|ZIPPO|local|onion|AARP|ABLE|ADAC|AERO|AIGO|AKDN|ALLY|AMEX|ARMY|ARPA|ARTE|ASDA|ASIA|AUDI|AUTO|BABY|BAND|BANK|BBVA|BEER|BEST|BIKE|BING|BLOG|BLUE|BOFA|BOND|BOOK|BUZZ|CAFE|CALL|CAMP|CARE|CARS|CASA|CASE|CASH|CBRE|CERN|CHAT|CITI|CITY|CLUB|COOL|COOP|CYOU|DATE|DCLK|DEAL|DELL|DESI|DIET|DISH|DOCS|DOHA|DUCK|DUNS|DVAG|ERNI|FAGE|FAIL|FANS|FARM|FAST|FIAT|FIDO|FILM|FIRE|FISH|FLIR|FOOD|FORD|FREE|FUND|GAME|GBIZ|GENT|GGEE|GIFT|GMBH|GOLD|GOLF|GOOG|GUGE|GURU|HAUS|HDFC|HELP|HERE|HGTV|HOST|HSBC|ICBC|IEEE|IMDB|IMMO|INFO|ITAU|JAVA|JEEP|JOBS|JPRS|KDDI|KIWI|KPMG|KRED|LAND|LEGO|LGBT|LIDL|LIFE|LIKE|LIMO|LINK|LIVE|LOAN|LOFT|LOVE|LTDA|LUXE|MAIF|MEET|MEME|MENU|MINI|MINT|MOBI|MODA|MOTO|MTPC|NAME|NAVY|NEWS|NEXT|NICO|NIKE|OLLO|OPEN|PAGE|PARS|PCCW|PICS|PING|PINK|PLAY|PLUS|POHL|PORN|POST|PROD|PROF|QPON|RAID|READ|REIT|RENT|REST|RICH|ROOM|RSVP|RUHR|SAFE|SALE|SAPO|SARL|SAVE|SAXO|SCOR|SCOT|SEAT|SEEK|SEXY|SHAW|SHIA|SHOP|SHOW|SILK|SINA|SITE|SKIN|SNCF|SOHU|SONG|SONY|SPOT|STAR|SURF|TALK|TAXI|TEAM|TECH|TEVA|TIAA|TIPS|TOWN|TOYS|TUBE|VANA|VISA|VIVA|VIVO|VOTE|VOTO|WANG|WEIR|WIEN|WIKI|WINE|WORK|XBOX|YOGA|ZARA|ZERO|ZONE|exit|zkey|AAA|ABB|ABC|ACO|ADS|AEG|AFL|AIG|ANZ|AOL|APP|ART|AWS|AXA|BAR|BBC|BBT|BCG|BCN|BET|BID|BIO|BIZ|BMS|BMW|BNL|BOM|BOO|BOT|BOX|BUY|BZH|CAB|CAL|CAM|CAR|CAT|CBA|CBN|CBS|CEB|CEO|CFA|CFD|COM|CRS|CSC|DAD|DAY|DDS|DEV|DHL|DIY|DNP|DOG|DOT|DTV|DVR|EAT|ECO|EDU|ESQ|EUS|FAN|FIT|FLY|FOO|FOX|FRL|FTR|FYI|GAL|GAP|GDN|GEA|GLE|GMO|GMX|GOO|GOP|GOT|GOV|HBO|HIV|HKT|HOT|HOW|HTC|IBM|ICE|ICU|IFM|ING|INK|INT|IST|ITV|IWC|JCB|JCP|JLC|JLL|JMP|JNJ|JOT|JOY|KFH|KIA|KIM|KPN|KRD|LAT|LAW|LDS|LOL|LPL|LTD|MAN|MBA|MCD|MED|MEN|MEO|MIL|MIT|MLB|MLS|MMA|MOE|MOI|MOM|MOV|MSD|MTN|MTR|NAB|NBA|NEC|NET|NEW|NFL|NGO|NHK|NOW|NRA|NRW|NTT|NYC|OBI|OFF|ONE|ONG|ONL|OOO|ORG|OTT|OVH|PAY|PET|PID|PIN|PNC|PRO|PRU|PUB|PWC|QVC|RED|REN|RIO|RIP|RUN|RWE|SAP|SAS|SBI|SBS|SCA|SCB|SES|SEW|SEX|SFR|SKI|SKY|SOY|SRL|SRT|STC|TAB|TAX|TCI|TDK|TEL|THD|TJX|TOP|TRV|TUI|TVS|UBS|UNO|UOL|UPS|VET|VIG|VIN|VIP|WED|WIN|WME|WOW|WTC|WTF|XIN|XXX|XYZ|YOU|YUN|ZIP|bit|gnu|i2p|AC|AD|AE|AF|AG|AI|AL|AM|AO|AQ|AR|AS|AT|AU|AW|AX|AZ|BA|BB|BD|BE|BF|BG|BH|BI|BJ|BM|BN|BO|BR|BS|BT|BV|BW|BY|BZ|CA|CC|CD|CF|CG|CH|CI|CK|CL|CM|CN|CO|CR|CU|CV|CW|CX|CY|CZ|DE|DJ|DK|DM|DO|DZ|EC|EE|EG|ER|ES|ET|EU|FI|FJ|FK|FM|FO|FR|GA|GB|GD|GE|GF|GG|GH|GI|GL|GM|GN|GP|GQ|GR|GS|GT|GU|GW|GY|HK|HM|HN|HR|HT|HU|ID|IE|IL|IM|IN|IO|IQ|IR|IS|IT|JE|JM|JO|JP|KE|KG|KH|KI|KM|KN|KP|KR|KW|KY|KZ|LA|LB|LC|LI|LK|LR|LS|LT|LU|LV|LY|MA|MC|MD|ME|MG|MH|MK|ML|MM|MN|MO|MP|MQ|MR|MS|MT|MU|MV|MW|MX|MY|MZ|NA|NC|NE|NF|NG|NI|NL|NO|NP|NR|NU|NZ|OM|PA|PE|PF|PG|PH|PK|PL|PM|PN|PR|PS|PT|PW|PY|QA|RE|RO|RS|RU|RW|SA|SB|SC|SD|SE|SG|SH|SI|SJ|SK|SL|SM|SN|SO|SR|ST|SU|SV|SX|SY|SZ|TC|TD|TF|TG|TH|TJ|TK|TL|TM|TN|TO|TR|TT|TV|TW|TZ|UA|UG|UK|US|UY|UZ|VA|VC|VE|VG|VI|VN|VU|WF|WS|YE|YT|ZA|ZM|ZW)",hostName="(?:"+domain+gtld+"|"+ipAddr+")",wellBrack="\\[["+pathChar+"]*(?:\\[["+pathChar+"]*\\]["+pathChar+"]*)*\\]",wellParen="\\(["+pathChar+"]*(?:\\(["+pathChar+"]*\\)["+pathChar+"]*)*\\)",wellAll=wellParen+"|"+wellBrack,pathCont="(?:["+pathChar+"]*(?:"+wellAll+"|["+endChar+"])+)+",path="(?:"+pathCont+"|/|\\b|$)",port="(?::[0-9]+)?",webURL="(?:"+hostName+port+"/"+path+")|(?:"+hostName+port+"(?:\\b|$))",scheme="(https?|ftp)://",strict="\\b"+scheme+pathCont,relaxed=strict+"|"+webURL;return this.linkregex=new RegExp(relaxed,"gi"),this._elem=$("<div/>"),this},destiny.fn.UrlFormatter.prototype.encodeUrl=function(value){return value.replace(/&/g,"&amp;").replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,function(value){var hi=value.charCodeAt(0),low=value.charCodeAt(1);return"&#"+(1024*(hi-55296)+(low-56320)+65536)+";"}).replace(/([^\#-~| |!])/g,function(value){return"&#"+value.charCodeAt(0)+";"}).replace(/</g,"&lt;").replace(/>/g,"&gt;")},destiny.fn.UrlFormatter.prototype.format=function(str){if(str){var self=this,extraclass="";return/\b(?:NSFL)\b/i.test(str)?extraclass=" nsfl-link":/\b(?:NSFW|SPOILER)\b/i.test(str)&&(extraclass=" nsfw-link"),str.replace(self.linkregex,function(url,scheme){scheme=scheme?"":"http://";var decodedUrl=self._elem.html(url).text(),m=decodedUrl.match(self.linkregex);if(!m)return url;url=self.encodeUrl(m[0]);var extra=self.encodeUrl(decodedUrl.substring(m[0].length));return'<a target="_blank" class="externallink'+extraclass+'" href="'+scheme+url+'" rel="nofollow">'+url+"</a>"+extra})}}}(jQuery),ChatMenu=function(){function cls(ui,chat){var scrollPlugin=null;this.ui=ui,this.chat=chat,this.btn=null,this.visible=!1,this.shown=!1,this.on=function(name,fn){$(this).on(name,fn)},this.show=function(btn){this.visible||(this.shown||$(this).triggerHandler("init"),this.visible=!0,this.shown=!0,this.btn=btn,$(this.btn).addClass("active"),$(this.ui).addClass("active"),$(this).triggerHandler("show"),$(this.ui).find(".scrollable").each(function(){scrollPlugin?scrollPlugin.reset():scrollPlugin=$(this).nanoScroller({disableResize:!0,preventPageScrolling:!0})[0].nanoscroller}))},this.hide=function(){this.visible&&(this.visible=!1,$(this.btn).removeClass("active"),$(this.ui).removeClass("active"),$(this).triggerHandler("hide"))},this.toggle=function(btn){var wasVisible=this.visible;ChatMenu.closeMenus(null),wasVisible||this.show(btn)},this.redraw=function(){scrollPlugin&&scrollPlugin.reset()},this.ui.on("click",".close",this.hide.bind(this)),menus.push(this)}var menus=[];return cls.closeMenus=function(){for(var i=0;i<menus.length;++i)menus[i].hide()},cls}(),function($){ChatGui=function(engine,options){return this.ui=$("#destinychat"),this.engine=engine,$.extend(this,options),this.init()},$.extend(ChatGui.prototype,{loaded:!1,maxlines:500,scrollPlugin:null,autoCompletePlugin:null,ui:null,lines:null,output:null,input:null,userMessages:[],focusedUsers:[],inputhistory:[],currenthistoryline:-1,storedinputline:null,backlog:[],backlogLoading:!1,highlightregex:{},lastMessage:null,emoticons:[],twitchemotes:[],formatters:[],pmcountnum:0,pmcount:null,stylesheet:null,preferences:{showtime:{value:!1,"default":!1},hideflairicons:{value:!1,"default":!1},timestampformat:{value:"HH:mm","default":"HH:mm"},maxlines:{value:500,"default":500},allowNotifications:{value:!1,"default":!1},highlight:{value:!0,"default":!0},customhighlight:{value:[],"default":[]},highlightnicks:{value:{},"default":{}}},trigger:function(name,data){$(this).trigger(name,data)},on:function(name,fn){$(this).on(name,fn)},init:function(){var chat=this;this.pmcount=this.ui.find("#chat-pm-count:first").eq(0),this.lines=this.ui.find("#chat-lines:first").eq(0),this.output=this.ui.find("#chat-output:first").eq(0),this.input=this.ui.find("#chat-input .input:first").eq(0),this.stylesheet=$("#chat-styles")[0].sheet,this.formatters.push(new destiny.fn.UrlFormatter(this)),this.formatters.push(new destiny.fn.EmoteFormatter(this)),this.formatters.push(new destiny.fn.MentionedUserFormatter(this)),this.formatters.push(new destiny.fn.GreenTextFormatter(this)),this.preferences.maxlines.value=this.maxlines,this.preferences.maxlines["default"]=this.maxlines,this.scrollPlugin=this.output.nanoScroller({disableResize:!0,preventPageScrolling:!0,sliderMinHeight:40,tabIndex:1})[0].nanoscroller,this.scrollPlugin.isScrolledToBottom=function(){return this.contentScrollTop>=this.maxScrollTop-30},this.scrollPlugin.updateAndScroll=function(scrollBottom){this.isActive&&(this.reset(),scrollBottom&&this.scrollBottom(0))},this.loadPreferences(),this.loadHighlighters(),this.loadInputHistory(),this.autoCompletePlugin=new ChatAutoComplete(this.input,this.emoticons.concat(this.twitchemotes));var chatSettingsUi=this.ui.find("#chat-settings:first").eq(0),chatSettingsMenu=new ChatMenu(chatSettingsUi,chat),chatSettingsNotificationText=this.ui.find("#chat-settings-notification-permissions"),updateChatSettingsNotificationText=function(){chatSettingsNotificationText.text("(Permission "+("default"===Notification.permission?"required":Notification.permission)+")")};chatSettingsUi.on("keypress blur","input[name=customhighlight]",function(e){var keycode=e.keyCode?e.keyCode:e.which;if(!keycode||13==keycode){for(var data=$(this).val().trim().split(","),i=data.length-1;i>=0;i--)data[i]=data[i].trim(),data[i]||data.splice(i,1);return chat.setPreference("customhighlight",data),chat.loadHighlighters(),!1}}),chatSettingsUi.on("change",'input[type="checkbox"]',function(){var name=$(this).attr("name"),checked=$(this).is(":checked");switch(name){case"showtime":chat.setPreference(name,checked),chat.scrollPlugin.updateAndScroll(chat.scrollPlugin.isScrolledToBottom());break;case"hideflairicons":chat.setPreference(name,checked),chat.scrollPlugin.updateAndScroll(chat.scrollPlugin.isScrolledToBottom());break;case"highlight":chat.setPreference(name,checked);break;case"allowNotifications":checked?chat.notificationPermission().then(function(){updateChatSettingsNotificationText(),chat.setPreference(name,!0)},function(){updateChatSettingsNotificationText(),chat.setPreference(name,!1)}):chat.setPreference(name,!1)}}),chatSettingsMenu.on("show",function(){chatSettingsUi.find("input[name=customhighlight]").val(chat.getPreference("customhighlight").join(", ")),chatSettingsUi.find('input[type="checkbox"]').each(function(){var name=$(this).attr("name");$(this).prop("checked",chat.getPreference(name))}),"granted"!==Notification.permission&&chatSettingsUi.find('input[name="allowNotifications"]').prop("checked",!1),updateChatSettingsNotificationText()});var chatEmotesUi=this.ui.find("#chat-emote-list:first").eq(0),chatEmotesUiMenu=new ChatMenu(chatEmotesUi,chat);chatEmotesUiMenu.on("init",function(){for(var demotes=chatEmotesUi.find("#destiny-emotes"),temotes=chatEmotesUi.find("#twitch-emotes"),i=0;i<chat.emoticons.length;i++)demotes.append('<div class="emote"><span title="'+chat.emoticons[i]+'" class="chat-emote chat-emote-'+chat.emoticons[i]+'">'+chat.emoticons[i]+"</span></div>");for(var x=0;x<chat.twitchemotes.length;x++)temotes.append('<div class="emote"><span title="'+chat.twitchemotes[x]+'" class="chat-emote chat-emote-'+chat.twitchemotes[x]+'">'+chat.twitchemotes[x]+"</span></div>");
chatEmotesUi.on("click",".chat-emote",function(e){var value=chat.input.val().trim();return chat.input.val(value+(""==value?"":" ")+$(this).text()+" "),chat.input.focus(),!1})});var pmPopupUi=this.ui.find("#chat-pm-notification:first").eq(0),pmPopupUiMenu=new ChatMenu(pmPopupUi,chat);pmPopupUi.on("click",".user-list-link",function(e){return ChatMenu.closeMenus(chat),userListUiMenu.show(pmPopupUiMenu.btn),!1}),pmPopupUi.on("click","#markread-privmsg",function(e){return chat.setUnreadMessageCount(0),ChatMenu.closeMenus(chat),$.ajax({type:"POST",url:"/profile/messages/openall"}),!1}),pmPopupUi.on("click","#inbox-privmsg",function(e){chat.setUnreadMessageCount(0),ChatMenu.closeMenus(chat)});var userListUi=this.ui.find("#chat-user-list:first").eq(0),userListUiMenu=new ChatMenu(userListUi,chat);userListUiMenu.groups=userListUi.find("#chat-groups"),userListUiMenu.clearAll=function(){userListUiMenu.groups.find("li").remove()},userListUiMenu.sortByName=function(a,b){try{return a.firstChild.getAttribute("data-username").localeCompare(b.firstChild.getAttribute("data-username"))}catch(e){}},userListUiMenu.sortUsers=function(){userListUiMenu.groups.children().each(function(){var users=$(this).find("li").get();users.sort(userListUiMenu.sortByName);for(var i=0;i<users.length;i++)users[i].parentNode.appendChild(users[i])})},userListUi.on("click",".user",function(){chat.toggleUserFocus(this.textContent)}),userListUi.each(function(){var header=userListUi.find("h5 span"),groups=userListUiMenu.groups,group1=$('<ul id="chat-group1">').appendTo(groups),group2=$('<ul id="chat-group2">').appendTo(groups),group3=$('<ul id="chat-group3">').appendTo(groups),group4=$('<ul id="chat-group4">').appendTo(groups),group5=$('<ul id="chat-group5">').appendTo(groups),updateCount=function(){var n=Object.keys(chat.engine.users).length;return header.text(n),n},hasUser=function(username){return userListUi.find('a[data-username="'+username+'"]').length>0},removeUser=function(username){return userListUi.find('a[data-username="'+username+'"]').closest("li").remove()},addUser=function(username){var u=chat.engine.users[username],elem='<li><a data-username="'+u.username+'" class="user '+u.features.join(" ")+'">'+u.username+"</a></li>";u.hasFeature(destiny.UserFeatures.BOT)||u.hasFeature(destiny.UserFeatures.BOT2)?group5.append(elem):u.hasFeature(destiny.UserFeatures.ADMIN)||u.hasFeature(destiny.UserFeatures.VIP)?group1.append(elem):u.hasFeature(destiny.UserFeatures.BROADCASTER)?group2.append(elem):u.hasFeature(destiny.UserFeatures.SUBSCRIBER)?group3.append(elem):group4.append(elem)};chat.on("join",function(e,data){userListUiMenu.visible&&!hasUser(data.nick)&&(addUser(data.nick),updateCount(),userListUiMenu.sortUsers(),userListUiMenu.redraw())}),chat.on("quit",function(e,data){userListUiMenu.visible&&hasUser(data.nick)&&(removeUser(data.nick),updateCount(),userListUiMenu.redraw())}),userListUiMenu.on("show",function(){userListUiMenu.clearAll(),updateCount();for(var username in chat.engine.users)chat.engine.users.hasOwnProperty(username)&&addUser(username);userListUiMenu.sortUsers(),userListUiMenu.redraw()})}),this.ui.find("#chat-users-btn").on("click",function(e){return chat.pmcountnum>0?pmPopupUiMenu.toggle(this):userListUiMenu.toggle(this),!1}),this.ui.find("#chat-settings-btn").on("click",function(e){return chatSettingsMenu.toggle(this),!1}),this.ui.find("#emoticon-btn").on("click",function(e){return chatEmotesUiMenu.toggle(this),!1}),this.lines.on("mousedown",".user-msg a.user",function(e){var username=$(this).closest(".user-msg").data("username");return chat.toggleUserFocus(username),!1}),this.lines.on("mousedown",".user-msg .chat-user",function(e){var username1=$(this).closest(".user-msg").data("username"),username2=this.textContent.toLowerCase();return chat.addUserFocus(username1),chat.toggleUserFocus(username2),!1}),this.ui.on("submit","form#chat-input",function(e){return chat.send(),!1}),this.input.on("keydown mousedown",$.proxy(function(){ChatMenu.closeMenus(this)},this)),this.output.on("mousedown",$.proxy(function(){ChatMenu.closeMenus(this),chat.clearUserFocus()},this));var scrollNotify=chat.ui.find("#chat-scroll-notify");scrollNotify.on("click",function(){chat.scrollPlugin.updateAndScroll(!0)}),chat.output.debounce("scrolled",function(){scrollNotify.toggle(!chat.scrollPlugin.isScrolledToBottom())},100),chat.output.debounce("scrollend",function(){scrollNotify.hide()},100);var fnUpdateScrollValues=chat.scrollPlugin.updateScrollValues;chat.scrollPlugin.updateScrollValues=function(){fnUpdateScrollValues.call(this,arguments),chat.output.trigger("scrolled")},this.ui.find('#chat-login-msg a[href="/login"]').on("click",function(e){try{window.self!==window.top?window.parent.location.href=$(this).attr("href")+"?follow="+encodeURIComponent(window.parent.location.pathname):window.location.href=$(this).attr("href")+"?follow="+encodeURIComponent(window.location.pathname)}catch(e){}return!1});var mouseDownCoords,focusTimer;return this.lines.on("click mousedown keydown",function(e){var coords=e.clientX+"-"+e.clientY;switch(e.type){case"click":if(mouseDownCoords!==coords)return;focusTimer=setTimeout(function(){chat.input.focus()},500);break;case"mousedown":mouseDownCoords=coords;break;case"keydown":focusTimer&&(clearTimeout(focusTimer),focusTimer=0)}}),this.lines.on("click",".mark-as-read",function(e){var messageEl=$(this).closest(".private-message"),message=messageEl.data("message"),messageIcnSend=message.ui.find(".icon-mail-send"),messageActions=message.ui.find(".message-actions");return $.ajax({type:"POST",url:"/profile/messages/"+encodeURIComponent(message.messageid)+"/open",complete:function(data){messageIcnSend.attr("class","icon-mail-open-document"),messageActions.remove(),chat.setUnreadMessageCount(data.unread)}}),!1}),$(window).on({"resize.chat":function(){chat.resize()},"focus.chat":function(){chat.input.focus()},"load.chat":function(){chat.input.focus(),chat.loaded=!0}}),this},addUserFocusRule:function(username){this.stylesheet.insertRule('.user-msg[data-username="'+username+'"]{opacity:1 !important;}',this.focusedUsers.length),this.focusedUsers.push(username),this.ui.toggleClass("focus-user",this.focusedUsers.length>0)},removeUserFocusRule:function(username,index){this.stylesheet.deleteRule(index),this.focusedUsers.splice(index,1),this.ui.toggleClass("focus-user",this.focusedUsers.length>0)},clearUserFocus:function(){for(var i=this.focusedUsers.length-1;i>=0;--i)this.removeUserFocusRule(this.focusedUsers[i],i);this.ui.toggleClass("focus-user",!1)},addUserFocus:function(username){username&&-1===this.focusedUsers.indexOf(username)&&this.addUserFocusRule(username)},removeUserFocus:function(username){if(username){username=username.toLowerCase();var index=this.focusedUsers.indexOf(username);-1!==index&&this.removeUserFocusRule(username,index)}},toggleUserFocus:function(username){if(username){username=username.toLowerCase();var index=this.focusedUsers.indexOf(username);-1===index?this.addUserFocus(username):this.removeUserFocus(username,index)}},loadBacklog:function(){if(this.backlogLoading=!0,0==this.backlog.length)return void(this.backlogLoading=!1);for(var i=0,j=this.backlog.length;j>i;i++)this.engine.dispatchBacklog(this.backlog[i]);this.put(new ChatUIMessage("<hr/>")),this.scrollPlugin.updateAndScroll(!0),this.backlogLoading=!1},put:function(message,state){return message instanceof ChatUserMessage?(this.lastMessage&&this.lastMessage.user&&message.user&&this.lastMessage.user.username==message.user.username?message.ui=$(message.addonHtml()):message.ui=$(message.html()),message.user&&this.engine.user&&this.engine.user.username==message.user.username&&message.ui.addClass("own-msg")):message.ui=$(message.html()),message.ui.data("message",message),message.ui.appendTo(this.lines),void 0!=state&&message.status(state),this.lastMessage=message,message},push:function(message,state){var wasScrolledBottom=this.scrollPlugin.isScrolledToBottom(),lines=this.lines.children(),maxlines=this.getPreference("maxlines"),lineCount=lines.length;if(wasScrolledBottom&&lineCount>=maxlines)for(var unwantedlines=lines.slice(0,lineCount-maxlines),i=unwantedlines.length-1;i>=0;i--)$(unwantedlines[i]).remove();return this.userMessages.push(message),this.put(message,state),this.scrollPlugin.content.scrollHeight>this.scrollPlugin.el.clientHeight&&!this.scrollPlugin.isActive&&this.scrollPlugin.reset(),this.scrollPlugin.updateAndScroll(wasScrolledBottom),this.handleHighlight(message),message},send:function(){var str=this.input.val().trim();if(""!=str){if(this.input.val("").focus(),null==this.engine.user||!this.engine.user.username)return this.push(new ChatErrorMessage(this.engine.errorstrings.needlogin));var message="/me "===str.substring(0,4)?str.substring(4):str;if(-1!==this.emoticons.indexOf(message)&&this.engine.previousemote&&this.engine.previousemote.message==message)return this.engine.emit("MSG",{data:str});if("/"===str.substring(0,1))return this.engine.handleCommand(str.substring(1));this.push(new ChatUserMessage(str,this.engine.user),this.engine.connected?"pending":"unsent"),this.engine.emit("MSG",{data:str}),this.insertInputHistory(str),this.currenthistoryline=-1,this.autoCompletePlugin.markLastComplete()}return str=null,this},resize:function(){return this.scrollPlugin.updateAndScroll(this.scrollPlugin.isScrolledToBottom()),this},setupInputHistory:function(){var modifierpressed=!1,chat=this;$(this.input).on("keyup",function(e){if((e.shiftKey||e.metaKey||e.ctrlKey)&&(modifierpressed=!0),38!=e.keyCode&&40!=e.keyCode||modifierpressed)return void(modifierpressed=!1);var num=38==e.keyCode?-1:1;if(chat.currenthistoryline<0&&38==e.keyCode){if(chat.currenthistoryline=chat.inputhistory.length,chat.storedinputline=chat.input.val(),chat.currenthistoryline<=0)return}else if(chat.currenthistoryline<0&&40==e.keyCode)return;var index=chat.currenthistoryline+num;return index>=chat.inputhistory.length||0>index?void(index>=chat.inputhistory.length&&(chat.input.val(chat.storedinputline),chat.currenthistoryline=-1)):(chat.currenthistoryline=index,void chat.input.val(chat.inputhistory[index]))})},loadInputHistory:function(){try{this.inputhistory=JSON.parse(localStorage.inputhistory||"[]"),this.setupInputHistory()}catch(e){}},insertInputHistory:function(message){this.inputhistory.push(message),this.inputhistory.length>20&&this.inputhistory.shift(),localStorage.inputhistory=JSON.stringify(this.inputhistory)},resolveMessage:function(data){for(var i=0;i<this.userMessages.length;++i)if(this.userMessages[i].message==data.data){var message=this.userMessages.splice(i,1)[0];return message.status(),message}return null},notificationPermission:function(){var deferred=$.Deferred();switch(Notification.permission){case"default":Notification.requestPermission(function(permission){switch(permission){case"granted":deferred.resolve(permission);break;default:deferred.reject(permission)}});break;case"granted":deferred.resolve(Notification.permission);break;case"denied":default:deferred.reject(Notification.permission)}return deferred.promise()},showNotification:function(message){if("granted"===Notification.permission){var n=new Notification(message.user.username+" said ...",{body:message.message,tag:message.timestamp.unix(),icon:destiny.cdn+"/chat/img/notifyicon.png",dir:"auto"});setTimeout(n.close.bind(n),5e3),n.onclick=function(){}}},loadHighlighters:function(){this.engine.user&&this.engine.user.username&&(this.highlightregex.user=new RegExp("\\b@?(?:"+this.engine.user.username+")\\b","i"));var highlights=this.getPreference("customhighlight");if(highlights.length>0){for(var i=highlights.length-1;i>=0;i--)highlights[i]=highlights[i].replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");this.highlightregex.custom=new RegExp("\\b(?:"+highlights.join("|")+")\\b","i")}},renewHighlight:function(nick,dohighlight){dohighlight?this.lines.children('div[data-username="'+nick.toLowerCase()+'"]').addClass("highlight"):this.lines.children('div[data-username="'+nick.toLowerCase()+'"]').removeClass("highlight")},handleHighlight:function(message){if(!message.user||!message.user.username||message.user.username==this.engine.user.username||!this.getPreference("highlight"))return!1;if(message.user.hasFeature(destiny.UserFeatures.BOT))return!1;var nicks=this.getPreference("highlightnicks");return(nicks[message.user.username.toLowerCase()]||nicks[message.user.username]||this.highlightregex.user&&this.highlightregex.user.test(message.message)||this.highlightregex.custom&&this.highlightregex.custom.test(message.message))&&(message.ui.addClass("highlight"),!this.getPreference("allowNotifications")||this.hasFocus()||this.backlogLoading||this.showNotification(message)),!1},setPreference:function(key,value){this.preferences[key].value=value,this.applyPreferencesCss(),this.savePreferences()},getPreference:function(key){return this.preferences[key].value||null},loadPreferences:function(){try{var preferences=JSON.parse(localStorage.chatoptions||"{}");for(var key in preferences)preferences.hasOwnProperty(key)&&this.preferences.hasOwnProperty(key)&&(this.preferences[key].value=preferences[key]);this.applyPreferencesCss()}catch(ignored){}},savePreferences:function(){try{var preferences={};for(var key in this.preferences)this.preferences.hasOwnProperty(key)&&(preferences[key]=this.preferences[key].value);localStorage.chatoptions=JSON.stringify(preferences)}catch(ignored){}},applyPreferencesCss:function(){for(var key in this.preferences)this.preferences.hasOwnProperty(key)&&"boolean"==typeof this.preferences[key].value&&this.ui.toggleClass("pref-"+key,this.preferences[key].value)},removeUserMessages:function(username){this.lines.children('div[data-username="'+username.toLowerCase()+'"]').remove(),this.scrollPlugin.reset()},setUnreadMessageCount:function(n){this.pmcountnum=Math.max(0,n),this.pmcount.toggleClass("hidden",!this.pmcountnum).text(this.pmcountnum)},hasFocus:function(){return this.input.is(":focus")}}),ChatUser=function(args){return args=args||{},this.nick=args.nick||"",this.username=args.nick||"",this.features=args.features||[],this},ChatUser.prototype.hasAnyFeatures=function(){for(var i=0;i<arguments.length;i++)if(-1!==this.features.indexOf(arguments[i]))return!0;return!1},ChatUser.prototype.hasFeature=function(feature){return this.hasAnyFeatures(feature)},ChatUIMessage=function(html){return this.init(html)},ChatUIMessage.prototype.init=function(html){return this.message=html,this},ChatUIMessage.prototype.html=function(){return this.wrap(this.wrapMessage())},ChatUIMessage.prototype.wrap=function(html){return'<div class="ui-msg">'+html+"</div>"},ChatUIMessage.prototype.wrapMessage=function(){return this.message},ChatMessage=function(message,timestamp){return this.init(message,timestamp)},ChatMessage.prototype.init=function(message,timestamp){return this.message=message,this.timestamp=moment.utc(timestamp).local(),this.state=null,this.type="chat",this.timestampformat=destiny.chat.gui.getPreference("timestampformat"),this},ChatMessage.prototype.status=function(state){return this.ui&&(state?this.ui.addClass(state):this.ui.removeClass(this.state)),this.state=state,this},ChatMessage.prototype.wrapTime=function(){return'<time title="'+this.timestamp.format("MMMM Do YYYY, h:mm:ss a")+'" datetime="'+this.timestamp.format("MMMM Do YYYY, h:mm:ss a")+'">'+this.timestamp.format(this.timestampformat)+"</time>"},ChatMessage.prototype.wrapMessage=function(){return $('<span class="msg"/>').text(this.message).get(0).outerHTML},ChatMessage.prototype.html=function(){return this.wrap(this.wrapTime()+" "+this.wrapMessage())},ChatMessage.prototype.wrap=function(content){return'<div class="'+this.type+'-msg">'+content+"</div>"},ChatErrorMessage=function(error,timestamp){return this.init(error,timestamp),this.type="error",this},$.extend(ChatErrorMessage.prototype,ChatMessage.prototype),ChatErrorMessage.prototype.html=function(){return this.wrap(this.wrapTime()+' <i class="icon-error"></i> '+this.wrapMessage())},ChatInfoMessage=function(message,timestamp){return this.init(message,timestamp),this.type="info",this},$.extend(ChatInfoMessage.prototype,ChatMessage.prototype),ChatInfoMessage.prototype.html=function(){return this.wrap(this.wrapTime()+' <i class="icon-info"></i> '+this.wrapMessage())},ChatInfoMessage.prototype.wrapMessage=function(){for(var elem=$('<span class="msg"/>').text(this.message),encoded=elem.html(),i=0;i<destiny.chat.gui.formatters.length;++i)encoded=destiny.chat.gui.formatters[i].format(encoded,null,this.message);return elem.html(encoded),elem.get(0).outerHTML},ChatCommandMessage=function(message,timestamp){return this.init(message,timestamp),this.type="command",this},$.extend(ChatCommandMessage.prototype,ChatMessage.prototype),ChatCommandMessage.prototype.html=function(){return this.wrap(this.wrapTime()+' <i class="icon-command"></i> '+this.wrapMessage())},ChatStatusMessage=function(message,timestamp){return this.init(message,timestamp),this.type="status",this},$.extend(ChatStatusMessage.prototype,ChatMessage.prototype),ChatStatusMessage.prototype.html=function(){return this.wrap(this.wrapTime()+' <i class="icon-status"></i> '+this.wrapMessage())},ChatBroadcastMessage=function(message,timestamp){return this.init(message,timestamp),this.type="broadcast",this.user={features:[null]},this},$.extend(ChatBroadcastMessage.prototype,ChatMessage.prototype),ChatBroadcastMessage.prototype.html=function(){return this.wrap(this.wrapTime()+" "+this.wrapMessage())},ChatBroadcastMessage.prototype.wrapMessage=function(){for(var elem=$('<span class="msg"/>').text(this.message),encoded=elem.html(),i=0;i<destiny.chat.gui.formatters.length;++i)encoded=destiny.chat.gui.formatters[i].format(encoded,null,this.message);return elem.html(encoded),elem.get(0).outerHTML},ChatUserMessage=function(message,user,timestamp){return this.init(message,timestamp),this.type="user",this.user=user,this.prepareMessage(),this},$.extend(ChatUserMessage.prototype,ChatMessage.prototype),ChatUserMessage.prototype.prepareMessage=function(){this.isSlashMe=!1,"/me "===this.message.substring(0,4)?(this.isSlashMe=!0,this.message=this.message.substring(4)):"//"===this.message.substring(0,2)&&(this.message=this.message.substring(1))},ChatUserMessage.prototype.wrap=function(html,css){return this.user&&this.user.username?'<div class="'+this.type+"-msg"+(css?" "+css:"")+'" data-username="'+this.user.username.toLowerCase()+'">'+html+"</div>":'<div class="'+this.type+"-msg"+(css?" "+css:"")+'">'+html+"</div>"},ChatUserMessage.prototype.getFeatureHTML=function(user){var icons="";user.hasFeature(destiny.UserFeatures.SUBSCRIBERT4)?icons+='<i class="icon-subscribert4" title="Subscriber (T4)"/>':user.hasFeature(destiny.UserFeatures.SUBSCRIBERT3)?icons+='<i class="icon-subscribert3" title="Subscriber (T3)"/>':user.hasFeature(destiny.UserFeatures.SUBSCRIBERT2)?icons+='<i class="icon-subscribert2" title="Subscriber (T2)"/>':user.hasFeature(destiny.UserFeatures.SUBSCRIBERT1)?icons+='<i class="icon-subscriber" title="Subscriber (T1)"/>':!user.hasFeature(destiny.UserFeatures.SUBSCRIBERT0)&&user.hasFeature(destiny.UserFeatures.SUBSCRIBER)&&(icons+='<i class="icon-subscriber" title="Subscriber (T1)"/>');for(var i=0;i<user.features.length;i++)switch(user.features[i]){case destiny.UserFeatures.SUBSCRIBERT0:icons+='<i class="icon-minitwitch" title="Twitch subscriber"/>';break;case destiny.UserFeatures.BOT:icons+='<i class="icon-bot" title="Bot"/>';break;case destiny.UserFeatures.BOT2:icons+='<i class="icon-bot2" title="Bot"/>';break;case destiny.UserFeatures.NOTABLE:icons+='<i class="icon-notable" title="Notable"/>';break;case destiny.UserFeatures.TRUSTED:icons+='<i class="icon-trusted" title="Trusted"/>';break;case destiny.UserFeatures.CONTRIBUTOR:icons+='<i class="icon-contributor" title="Contributor"/>';break;case destiny.UserFeatures.COMPCHALLENGE:icons+='<i class="icon-compchallenge" title="Composition Winner"/>';break;case destiny.UserFeatures.EVE:icons+='<i class="icon-eve" title="Eve"/>';break;case destiny.UserFeatures.SC2:icons+='<i class="icon-sc2" title="Starcraft 2"/>';break;case destiny.UserFeatures.BROADCASTER:icons+='<i class="icon-broadcaster" title="Broadcaster"/>'}return icons},ChatUserMessage.prototype.wrapUser=function(user){return(this.isSlashMe?"":this.getFeatureHTML(user))+' <a class="user '+user.features.join(" ")+'">'+user.username+"</a>"},ChatUserMessage.prototype.wrapMessage=function(){var elem=$('<span class="msg"/>').text(this.message),encoded=elem.html();this.isSlashMe&&elem.addClass("emote");for(var i=0;i<destiny.chat.gui.formatters.length;++i)encoded=destiny.chat.gui.formatters[i].format(encoded,this.user,this.message);return elem.html(encoded),elem.get(0).outerHTML},ChatUserMessage.prototype.html=function(){return this.wrap(this.wrapTime()+" "+(this.isSlashMe?"*":"")+this.wrapUser(this.user)+(this.isSlashMe?" ":": ")+this.wrapMessage())},ChatUserMessage.prototype.addonHtml=function(){return this.isSlashMe?this.wrap(this.wrapTime()+" *"+this.wrapUser(this.user)+" "+this.wrapMessage()):this.wrap(this.wrapTime()+' <span class="continue">&gt;</span> '+this.wrapMessage(),"continue")},ChatUserPrivateMessage=function(data,user,messageid,timestamp){return this.init(data,timestamp),this.type="user",this.user=user,this.messageid=messageid,this.prepareMessage(),this.isSlashMe=!1,this},$.extend(ChatUserPrivateMessage.prototype,ChatUserMessage.prototype),ChatUserPrivateMessage.prototype.wrap=function(html,css){return'<div class="'+this.type+"-msg"+(css?" "+css:"")+' private-message" data-messageid="'+this.messageid+'" data-username="'+this.user.username.toLowerCase()+'">'+html+'<span class="message-actions"><a href="#" class="mark-as-read">Mark as read <i class="fa fa-check-square-o"></i></a></span><i class="speech-arrow"></i></div>'},ChatUserPrivateMessage.prototype.wrapUser=function(user){return' <i class="icon-mail-send" title="Received Message"></i> <a class="user">'+user.username+"</a>"},ChatEmoteMessage=function(emote,timestamp){return this.init(emote,timestamp),this.emotecount=1,this.emotecountui=null,this},$.extend(ChatEmoteMessage.prototype,ChatMessage.prototype),ChatEmoteMessage.prototype.getEmoteCountLabel=function(){return"<i class='count'>"+this.emotecount+"</i><i class='x'>X</i> C-C-C-COMBO"},ChatEmoteMessage.prototype.html=function(){return this.wrap(this.wrapTime()+" "+this.wrapMessage()+'<span class="emotecount">'+this.getEmoteCountLabel()+"<span>")},ChatEmoteMessage.prototype.wrapMessage=function(){for(var elem=$('<span class="msg"/>').text(this.message),encoded=elem.html(),i=0;i<destiny.chat.gui.formatters.length;++i)encoded=destiny.chat.gui.formatters[i].format(encoded,null,this.message);return elem.html(encoded),elem.get(0).outerHTML},ChatEmoteMessage.prototype.incEmoteCount=function(){++this.emotecount;var stepClass="";this.emotecount>=50?stepClass=" x50":this.emotecount>=30?stepClass=" x30":this.emotecount>=20?stepClass=" x20":this.emotecount>=10?stepClass=" x10":this.emotecount>=5&&(stepClass=" x5"),null==this.emotecountui&&(this.emotecountui=this.ui.find(".emotecount")),this.emotecountui.detach().attr("class","emotecount"+stepClass).html(this.getEmoteCountLabel()).appendTo(this.ui)}}(jQuery),destiny.UserFeatures={PROTECTED:"protected",SUBSCRIBER:"subscriber",SUBSCRIBERT0:"flair9",SUBSCRIBERT1:"flair13",SUBSCRIBERT2:"flair1",SUBSCRIBERT3:"flair3",SUBSCRIBERT4:"flair8",VIP:"vip",MODERATOR:"moderator",ADMIN:"admin",BROADCASTER:"flair12",BOT:"bot",BOT2:"flair11",NOTABLE:"flair2",TRUSTED:"flair4",CONTRIBUTOR:"flair5",COMPCHALLENGE:"flair6",EVE:"flair7",SC2:"flair10"},chat.prototype.start=function(){return window.MozWebSocket&&(window.WebSocket=MozWebSocket),window.WebSocket?(this.dispatchBacklog=$.proxy(this.dispatchBacklog,this),this.gui.loadBacklog(),this.loadIgnoreList(),this.gui.push(new ChatStatusMessage("Connecting...")),this.init(),this):this.gui.push(new ChatErrorMessage(this.errorstrings.requiresocket))},chat.prototype.l=function(){if(this.debug){var log=Function.prototype.bind.call(console.log,console);log.apply(console,arguments)}},chat.prototype.init=function(){this.sock=new WebSocket(this.server),this.sock.onopen=$.proxy(function(){var event={data:'OPEN ""'};this.parseAndDispatch(event)},this),this.sock.onerror=$.proxy(function(){var event={data:'ERR "socketerror"'};this.parseAndDispatch(event)},this),this.sock.onmessage=$.proxy(this.parseAndDispatch,this),this.sock.onclose=$.proxy(function(){var event={data:'CLOSE ""'};this.parseAndDispatch(event)},this),this.l=$.proxy(this.l,this),this.emit=$.proxy(this.emit,this)},chat.prototype.loadIgnoreList=function(){try{this.ignorelist=JSON.parse(localStorage.chatignorelist||"{}")}catch(e){}this.ignoreregex=null},chat.prototype.parseAndDispatch=function(e){var eventname=e.data.split(" ",1)[0],handler="on"+eventname,obj=JSON.parse(e.data.substring(eventname.length+1));return this.l(handler,obj),"PING"==eventname?this.sock.send("PONG "+e.data.substring(eventname.length+1)):void(this[handler]&&this[handler](obj))},chat.prototype.dispatchBacklog=function(line){var eventname=line.split(" ",1)[0],handler="on"+eventname,obj=JSON.parse(line.substring(eventname.length+1));this.users[obj.nick]||(this.users[obj.nick]=new ChatUser(obj)),this[handler]&&this[handler](obj)},chat.prototype.emit=function(eventname,data){this.sock.send(eventname+" "+JSON.stringify(data))},chat.prototype.onOPEN=function(){this.connected=!0},chat.prototype.onCLOSE=function(){if(!this.dontconnect){var rand=this.connected?getRandomInt(501,3e3):getRandomInt(5e3,3e4);setTimeout($.proxy(this.onRECONNECT,this),rand),this.connected=!1,this.gui.push(new ChatStatusMessage("Disconnected... reconnecting in "+Math.round(rand/1e3)+" seconds"))}},chat.prototype.onNAMES=function(data){if(data.users){for(var i=data.users.length-1;i>=0;i--){var u=data.users[i];this.users[u.nick]=new ChatUser(u),this.shouldIgnore(u.nick,"")||this.gui.autoCompletePlugin.addNick(u.nick)}this.gui.trigger("names",data)}this.gui.push(new ChatStatusMessage("Connected. Server connections: "+data.connectioncount)),this.showstarthint&&(this.showstarthint=!1,this.handleCommand("hint"))},chat.prototype.onJOIN=function(data){this.users[data.nick]=new ChatUser(data),this.shouldIgnore(data.nick,"")||this.gui.autoCompletePlugin.addNick(data.nick),this.gui.trigger("join",data)},chat.prototype.onQUIT=function(data){this.users[data.nick]&&(delete this.users[data.nick],this.gui.trigger("quit",data))},chat.prototype.shouldIgnore=function(nick,message){if(!this.ignorelist)return!1;if(!this.ignoreregex){var nicks=[];if($.each(this.ignorelist,function(key){nicks.push(key.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"))}),0==nicks.length)return!1;this.ignoreregex=new RegExp(nicks.join("|"),"i")}return nick=nick.toLowerCase(),this.ignorelist[nick]||this.ignoreregex.test(message)},chat.prototype.onPRIVMSG=function(data){var user=this.users[data.nick];user||(user=new ChatUser(data)),this.shouldIgnore(data.nick,data.data)||(this.gui.autoCompletePlugin.updateNick(user.username),this.gui.setUnreadMessageCount(this.gui.pmcountnum+1),this.gui.push(new ChatUserPrivateMessage(data.data,user,data.messageid,data.timestamp)))},chat.prototype.onMSG=function(data){this.user.username==data.nick&&Array.isArray(data.features)&&(this.user.features=data.features);var emoticon="/me "===data.data.substring(0,4)?data.data.substring(4):data.data;if(-1!==this.gui.emoticons.indexOf(emoticon)||-1!==this.gui.twitchemotes.indexOf(emoticon)){if(this.previousemote&&this.previousemote.message==emoticon)return 1===this.previousemote.emotecount?(this.previousemote.emotecount=2,this.originemote&&(this.originemote.ui.remove(),this.originemote=null),void this.gui.push(this.previousemote)):void this.previousemote.incEmoteCount();this.previousemote=new ChatEmoteMessage(emoticon,data.timestamp)}else this.previousemote=null;var messageui=this.gui.resolveMessage(data);if(messageui&&this.previousemote&&(this.originemote=messageui),this.user.username!=data.nick||!messageui){if(this.shouldIgnore(data.nick,data.data))return;var user=this.users[data.nick];user?this.gui.autoCompletePlugin.updateNick(data.nick):(user=new ChatUser(data),""!=user.nick&&user.nick==this.user.nick&&(this.user=user)),user&&user.features.length!=data.features.length&&(this.users[data.nick]=user);var usermessage=new ChatUserMessage(data.data,user,data.timestamp);this.previousemote&&(this.originemote=usermessage),this.gui.push(usermessage)}},chat.prototype.onMUTE=function(data){var suppressednick=data.data;this.user.username.toLowerCase()==data.data.toLowerCase()?suppressednick="You have been":this.user.hasAnyFeatures(destiny.UserFeatures.SUBSCRIBERT3,destiny.UserFeatures.SUBSCRIBERT4,destiny.UserFeatures.SUBSCRIBERT2,destiny.UserFeatures.ADMIN,destiny.UserFeatures.MODERATOR)||this.gui.removeUserMessages(data.data),this.gui.push(new ChatCommandMessage(suppressednick+" muted by "+data.nick,data.timestamp))},chat.prototype.onUNMUTE=function(data){var suppressednick=data.data;this.user.username.toLowerCase()==data.data.toLowerCase()&&(suppressednick="You have been"),this.gui.push(new ChatCommandMessage(suppressednick+" unmuted by "+data.nick,data.timestamp))},chat.prototype.onBAN=function(data){var suppressednick=data.data;this.user.username.toLowerCase()==data.data.toLowerCase()?(suppressednick="You have been",this.gui.backlogLoading||setTimeout(function(){window.location.href="/banned"},1500)):this.user.hasAnyFeatures(destiny.UserFeatures.SUBSCRIBERT3,destiny.UserFeatures.SUBSCRIBERT4,destiny.UserFeatures.SUBSCRIBERT2,destiny.UserFeatures.ADMIN,destiny.UserFeatures.MODERATOR)||this.gui.removeUserMessages(data.data),this.gui.push(new ChatCommandMessage(suppressednick+" banned by "+data.nick,data.timestamp))},chat.prototype.onUNBAN=function(data){var suppressednick=data.data;this.user.username.toLowerCase()==data.data.toLowerCase()&&(suppressednick="You have been"),this.gui.push(new ChatCommandMessage(suppressednick+" unbanned by "+data.nick,data.timestamp))},chat.prototype.onERR=function(data){("toomanyconnections"==data||"banned"==data)&&(this.dontconnect=!0),"banned"!=data||this.gui.backlogLoading||(window.location.href="/banned"),this.gui.push(new ChatErrorMessage(this.errorstrings[data]))},chat.prototype.onREFRESH=function(){window.location.href=window.location.href},chat.prototype.onRECONNECT=function(){this.init()},chat.prototype.onSUBONLY=function(data){var submode="on"==data.data?"enabled":"disabled";this.gui.push(new ChatCommandMessage("Subscriber only mode "+submode+" by "+data.nick,data.timestamp))},chat.prototype.onBROADCAST=function(data){if(!this.gui.backlogLoading)if("redirect:"==data.data.substring(0,9)){var url=data.data.substring(9);_gaq.push(["_trackEvent","outbound","chat-redirect",url]),_gaq.push(function(){setTimeout(function(){window.parent&&(window.parent.location.href=url),window.location.href=url},5e3)}),this.gui.push(new ChatBroadcastMessage("Redirecting in 5 seconds to "+url,data.timestamp))}else this.gui.push(new ChatBroadcastMessage(data.data,data.timestamp))},chat.prototype.onPRIVMSGSENT=function(data){this.gui.push(new ChatInfoMessage("Your message has been sent!"))},chat.prototype.handleCommand=function(str){if(!str.length)return void this.gui.push(new ChatErrorMessage("Empty command"));var parts=str.match(/([^ ]+)/g),command=parts[0].toLowerCase(),nickregex=/^[a-zA-Z0-9_]{3,20}$/,payload={},nicks=[],nick="";if("/"===str.substring(0,1))return payload.data="/"+str,void this.emit("MSG",payload);switch(this.l(command,parts),command){default:this.gui.push(new ChatErrorMessage("Unknown command"));break;case"emotes":this.gui.push(new ChatInfoMessage("Available emoticons: "+this.gui.emoticons.join(", ")+" (www.destiny.gg/emotes)"));break;case"help":this.gui.push(new ChatInfoMessage("Available commands: /emotes /me /msg /ignore (without arguments to list the nicks ignored) /unignore /highlight (highlights target nicks messages for easier visibility) /unhighlight /maxlines /mute /unmute /subonly /ban /ipban /unban (also unbans ip bans) /timestampformat"));
break;case"me":payload.data="/"+str,this.emit("MSG",payload);break;case"message":case"msg":case"whisper":case"w":case"tell":case"t":case"notify":if(!parts[1]||!nickregex.test(parts[1].toLowerCase()))return void this.gui.push(new ChatErrorMessage("Invalid nick - /msg nick message"));if(parts[1].toLowerCase()==this.user.username.toLowerCase())return void this.gui.push(new ChatErrorMessage("Cannot send a message to yourself"));payload.nick=parts[1],parts.shift(),parts.shift(),payload.data=parts.join(" "),this.emit("PRIVMSG",payload),this.gui.autoCompletePlugin.markLastComplete();break;case"ignore":if(!localStorage)return void this.gui.push(new ChatErrorMessage("Ignore is unavailable, no localStorage"));if(!parts[1])return nicks=[],$.each(this.ignorelist,function(key){nicks.push(key)}),0==nicks.length?void this.gui.push(new ChatInfoMessage("Your ignore list is empty")):void this.gui.push(new ChatInfoMessage("Ignoring the following people: "+nicks.join(", ")));if(nick=parts[1].toLowerCase(),!nickregex.test(nick))return void this.gui.push(new ChatErrorMessage("Invalid nick - /ignore nick"));this.ignorelist[nick]=!0,this.gui.removeUserMessages(nick),this.gui.push(new ChatStatusMessage("Ignoring "+nick)),localStorage.chatignorelist=JSON.stringify(this.ignorelist),this.loadIgnoreList();break;case"unignore":if(!localStorage)return void this.gui.push(new ChatErrorMessage("Ignore is unavailable, no localStorage"));if(!parts[1]||!nickregex.test(parts[1].toLowerCase()))return void this.gui.push(new ChatErrorMessage("Invalid nick - /ignore nick"));nick=parts[1].toLowerCase(),delete this.ignorelist[nick],this.gui.push(new ChatStatusMessage(""+nick+" has been removed from your ignore list")),localStorage.chatignorelist=JSON.stringify(this.ignorelist),this.loadIgnoreList();break;case"mute":if(1==parts.length)return void this.gui.push(new ChatInfoMessage("Usage: /"+command+" nick[ time]"));if(!nickregex.test(parts[1]))return void this.gui.push(new ChatErrorMessage("Invalid nick - /"+command+" nick[ time]"));var duration=null;parts[2]&&(duration=this.parseTimeInterval(parts[2])),payload.data=parts[1],duration&&duration>0&&(payload.duration=duration),this.emit(command.toUpperCase(),payload);break;case"ban":case"ipban":if(parts.length<4)return void this.gui.push(new ChatInfoMessage("Usage: /"+command+" nick time reason (time can be 'permanent')"));if(!nickregex.test(parts[1]))return void this.gui.push(new ChatErrorMessage("Invalid nick"));if(payload.nick=parts[1],"ipban"==command&&(payload.banip=!0),/^perm/i.test(parts[2])?payload.ispermanent=!0:payload.duration=this.parseTimeInterval(parts[2]),payload.reason=parts.slice(3,parts.length).join(" "),!payload.reason)return void this.gui.push(new ChatErrorMessage("Providing a reason is mandatory"));this.emit("BAN",payload);break;case"unmute":case"unban":if(1==parts.length)return void this.gui.push(new ChatInfoMessage("Usage: /"+command+" nick"));if(!nickregex.test(parts[1]))return void this.gui.push(new ChatErrorMessage("Invalid nick - /"+command+" nick"));payload.data=parts[1],this.emit(command.toUpperCase(),payload);break;case"subonly":if("on"!=parts[1]&&"off"!=parts[1])return void this.gui.push(new ChatErrorMessage("Invalid argument - /"+command+" on/off"));payload.data=parts[1],this.emit(command.toUpperCase(),payload);break;case"maxlines":if(!parts[1])return void this.gui.push(new ChatInfoMessage("Current number of lines shown: "+this.gui.getPreference("maxlines")));var newmaxlines=Math.abs(parseInt(parts[1],10));if(!newmaxlines)return void this.gui.push(new ChatErrorMessage("Invalid argument - /maxlines is expecting a number"));this.gui.setPreference("maxlines",newmaxlines),this.gui.push(new ChatInfoMessage("Current number of lines shown: "+this.gui.getPreference("maxlines")));break;case"unhighlight":case"highlight":var highlightnicks=this.gui.getPreference("highlightnicks");if(!parts[1])return nicks=[],$.each(highlightnicks,function(k){nicks.push(k)}),void this.gui.push(new ChatInfoMessage("Currently highlighted users: "+nicks.join(", ")));if(!nickregex.test(parts[1]))return void this.gui.push(new ChatErrorMessage("Invalid nick - /"+command+" nick"));nick=parts[1].toLowerCase();var dohighlight="highlight"==command;dohighlight?(highlightnicks[nick]=!0,this.gui.push(new ChatInfoMessage("Now highlighting: "+nick))):(delete highlightnicks[nick],this.gui.push(new ChatInfoMessage("No longer highlighting: "+nick))),this.gui.renewHighlight(nick,dohighlight),this.gui.setPreference("highlightnicks",highlightnicks);break;case"timestampformat":if(!parts[1])return void this.gui.push(new ChatInfoMessage("Current format: "+this.gui.getPreference("timestampformat")+" (the default is 'HH:mm', for more info: http://momentjs.com/docs/#/displaying/format/)"));var format=str.substring(command.length);if(!/^[a-z :.,-\\*]+$/i.test(format))return void this.gui.push(new ChatErrorMessage("Invalid format, see: http://momentjs.com/docs/#/displaying/format/"));this.gui.setPreference("timestampformat",format),this.gui.push(new ChatInfoMessage("New format: "+this.gui.getPreference("timestampformat")));break;case"broadcast":payload.data=str.substring(command.length+1),this.emit(command.toUpperCase(),payload);break;case"hint":for(var id="",hint=null,shownhints=JSON.parse(localStorage.hiddenhints||"[]"),i=0;++i;){if(i>=this.hintindex.length){id=this.hintindex[0],hint=this.hints[id],shownhints=[id];break}if(-1===shownhints.indexOf(this.hintindex[i])){id=this.hintindex[i],hint=this.hints[id],shownhints.push(id);break}}localStorage.hiddenhints=JSON.stringify(shownhints),this.gui.push(new ChatInfoMessage(hint))}},chat.prototype.parseTimeInterval=function(str){var nanoseconds=0,units={s:1e9,sec:1e9,secs:1e9,second:1e9,seconds:1e9,m:6e10,min:6e10,mins:6e10,minute:6e10,minutes:6e10,h:36e11,hr:36e11,hrs:36e11,hour:36e11,hours:36e11,d:864e11,day:864e11,days:864e11};return str.replace(/(\d+(?:\.\d*)?)([a-z]+)?/gi,function($0,number,unit){number*=unit?units[unit.toLowerCase()]||units.s:units.s,nanoseconds+=+number}),nanoseconds};
//# sourceMappingURL=chat.min.js.map